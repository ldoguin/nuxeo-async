<div xmlns:c="http://java.sun.com/jstl/core"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:nxd="http://nuxeo.org/nxweb/document"
  xmlns:nxl="http://nuxeo.org/nxforms/layout"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:nxp="http://nuxeo.org/nxweb/pdf">

  <script src="//cdn.sockjs.org/sockjs-0.2.1.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/vertx/1.2.3/vertxbus.min.js"></script>

<div id="send">
  <form onsubmit="return false;">
    Message:<input type="text" id="sendMessage" value="Hello, World!"/>
    <input type="button" id="sendButton" value="Send message"/>
  </form>
</div>

<br />

<div id="receive" >
  Received messages:<br />
  <div id="received" >
  </div>
</div>

<div id="status">
  <div id="status_info">Not connected</div>
  <span id="subscribed"></span> 
</div>


<script>

  var eb = null;
  var chanAddress = '/chated/#{currentDocument.id}';
  var userId = '#{currentUser.name}';
  var userToken = 'token';

  function publish(address, message) {
    if (eb) {
      var json = {text: message, user:userId, token:userToken};
      eb.publish(address, json);
    }
  }

  function subscribe(address) {
    if (eb) {
      eb.registerHandler(address, function(msg, replyTo) {
        jQuery('#received').prepend(msg.text + '&lt;br&gt;');
      });
      jQuery('#subscribed').append(jQuery('&lt;code&gt;').text('to ' + address));
      jQuery('#subscribed').append(jQuery('&lt;/code&gt;&lt;br&gt;'));
      publish(chanAddress, "#{currentUser.name} connected");
    }
  }

  function closeConn() {
    if (eb) {
      eb.close();
    }
  }

  function openConn() {
    if (!eb) {
      eb = new vertx.EventBus("http://localhost:8180/chated");

      eb.onopen = function() {
        jQuery("#status_info").text("Connected");
        subscribe(chanAddress);
      };

      eb.onclose = function() {
        jQuery("#status_info").text("Not connected");
        eb = null;
      };
      
    }
  }

  jQuery(document).ready(function() {
  
    jQuery(window).unload(function() {
      closeConn();
    });

    jQuery('#sendButton').click(function() {
      publish(chanAddress, jQuery('#sendMessage').val());
    });
  
    openConn();

  });

</script>

</div>